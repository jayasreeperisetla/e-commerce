```markdown
### Function: create_user
- **Test Case 1 (Positive):** Call `create_user` with valid `user_in` data (including email). `crud.get_user_by_email` returns `None`. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. `generate_new_account_email` is called once. `send_email` is called once.  Expects the created user object to be returned.
- **Test Case 2 (Negative):** Call `create_user` with `user_in` data where email already exists. `crud.get_user_by_email` returns a user object. `crud.create_user` is not called. Expects `HTTPException` with status code 400 and detail "The user with this email already exists in the system." to be raised.
- **Test Case 3 (Edge):** Call `create_user` with `user_in` data with an empty email. `crud.get_user_by_email` is called with an empty email. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. `generate_new_account_email` is not called. `send_email` is not called. Expects the created user object to be returned.
- **Test Case 4 (Negative):** Call `create_user` with invalid `user_in` data (missing required fields). `crud.get_user_by_email` is not called. `crud.create_user` raises an exception.  Expects the exception raised by `crud.create_user` to be propagated.
- **Test Case 5 (Edge):** Call `create_user` with `user_in` data containing only whitespace in email field. `crud.get_user_by_email` is called with whitespace string. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. `generate_new_account_email` is not called. `send_email` is not called. Expects the created user object to be returned.
- **Test Case 6 (Negative):** `settings.emails_enabled` is False. `crud.get_user_by_email` returns `None`. `crud.create_user` is called once and returns a user object. `generate_new_account_email` is not called. `send_email` is not called. Expects the created user object to be returned.
- **Test Case 7 (Negative):** `crud.create_user` raises an exception. `crud.get_user_by_email` returns `None`. Expects the exception raised by `crud.create_user` to be propagated.
- **Test Case 8 (Edge):** `user_in.email` is None. `crud.get_user_by_email` is not called. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. `generate_new_account_email` is not called. `send_email` is not called. Expects the created user object to be returned.
- **Test Case 9 (Negative):** `generate_new_account_email` raises an exception. `crud.get_user_by_email` returns `None`. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. Expects the exception raised by `generate_new_account_email` to be propagated.
- **Test Case 10 (Negative):** `send_email` raises an exception. `crud.get_user_by_email` returns `None`. `crud.create_user` is called once and returns a user object. `settings.emails_enabled` is True. `generate_new_account_email` is called once. Expects the exception raised by `send_email` to be propagated.


### Function: send_email
- **Test Case 1 (Positive):** Call `send_email` with valid email, subject, and html content. `settings.emails_enabled` is True. `message.send` is called once and returns a successful response (mocked). `logger.info` is called once. Expects no exception.
- **Test Case 2 (Negative):** Call `send_email` with `settings.emails_enabled` is False. Expects `AssertionError: no provided configuration for email variables` to be raised.
- **Test Case 3 (Edge):** Call `send_email` with empty email_to. `settings.emails_enabled` is True. `message.send` is called once and returns a mocked response. `logger.info` is called once. Expects no exception (assuming `message.send` handles empty `to` gracefully).
- **Test Case 4 (Edge):** Call `send_email` with empty subject and html_content. `settings.emails_enabled` is True. `message.send` is called once and returns a mocked response. `logger.info` is called once. Expects no exception.
- **Test Case 5 (Negative):** Call `send_email` with invalid email address. `settings.emails_enabled` is True. `message.send` is called once and raises an exception (mocked). `logger.info` is called once. Expects the exception raised by `message.send` to be propagated.
- **Test Case 6 (Edge):**  `settings.SMTP_HOST` is None. `settings.emails_enabled` is True.  Expects `message.send` to raise an exception or handle the missing host gracefully (depending on the `message.send` implementation).  `logger.info` is called once.
- **Test Case 7 (Edge):** `settings.SMTP_PORT` is 0. `settings.emails_enabled` is True. Expects `message.send` to raise an exception or handle the invalid port gracefully (depending on the `message.send` implementation). `logger.info` is called once.
- **Test Case 8 (Negative):** `settings.SMTP_USER` and `settings.SMTP_PASSWORD` are provided but authentication fails (mocked). `settings.emails_enabled` is True. `message.send` is called once and raises an exception (mocked). `logger.info` is called once. Expects the exception raised by `message.send` to be propagated.
- **Test Case 9 (Edge):** `settings.SMTP_TLS` and `settings.SMTP_SSL` are both True (invalid configuration). `settings.emails_enabled` is True. Expects `message.send` to raise an exception or handle the conflicting settings gracefully (depending on the `message.send` implementation). `logger.info` is called once.
- **Test Case 10 (Negative):** `message.send` raises an unexpected exception (mocked). `settings.emails_enabled` is True. `logger.info` is called once. Expects the unexpected exception to be propagated.

```